<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Tree Visualization</title>
    <style>
        :root {
            --bg-color: #f0f4f0;
            --tree-line: #1b5e20;
            --card-bg: #ffffff;
            --card-border: #2e7d32;
            --text-main: #1b5e20;
            --text-sub: #4caf50;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent default browser scroll we use custom pan */
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        header {
            background: white;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--text-main);
            margin: 0;
            font-size: 18px;
        }

        button {
            background-color: var(--tree-line);
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 5px;
            font-size: 13px;
        }

        /* Zoom Controls (Floating) */
        .zoom-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            padding: 0;
        }

        /* Viewport Container for Panning */
        #viewport {
            flex-grow: 1;
            overflow: hidden; /* Hide overflow */
            cursor: grab;
            position: relative;
            background-image: radial-gradient(#ccc 1px, transparent 1px);
            background-size: 20px 20px; /* Dot grid background */
        }

        #viewport:active {
            cursor: grabbing;
        }

        /* The Tree Content Layer */
        .tree-layer {
            position: absolute;
            top: 0;
            left: 0;
            transform-origin: 0 0; /* Scaling happens from top-left */
            transition: transform 0.1s linear; /* Smooth movement */
        }

        /* --- TREE CSS LOGIC --- */
        .tree {
            display: flex;
            justify-content: center;
            padding: 50px; /* Padding inside the zoomable area */
            width: max-content; /* Ensure div is as wide as the tree */
        }

        .tree ul {
            padding-top: 20px;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .tree li {
            float: left;
            text-align: center;
            list-style-type: none;
            position: relative;
            padding: 20px 5px 0 5px;
        }

        /* Connectors */
        .tree li::before, .tree li::after {
            content: '';
            position: absolute;
            top: 0;
            right: 50%;
            border-top: 2px solid var(--tree-line);
            width: 50%;
            height: 20px;
        }

        .tree li::after {
            right: auto;
            left: 50%;
            border-left: 2px solid var(--tree-line);
        }

        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 2px solid var(--tree-line); border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            border-left: 2px solid var(--tree-line);
            width: 0;
            height: 20px;
        }

        /* Member Card */
        .member-container {
            display: inline-flex;
            gap: 10px;
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 10px;
            border: 1px dashed var(--tree-line);
        }

        .card {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            border-radius: 8px;
            padding: 10px;
            width: 160px;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            position: relative;
        }

        .card img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--tree-line);
            margin-bottom: 5px;
            background: #eee;
        }

        .card h3 { margin: 5px 0; font-size: 14px; color: var(--text-main); }
        .card .title { font-size: 11px; font-weight: bold; color: var(--text-sub); }
        .card .details { font-size: 10px; color: #555; line-height: 1.4; }
        .card .status-dead { color: red; }
        .card .status-alive { color: green; }

        #loading { padding: 20px; text-align: center; }

    </style>
</head>
<body>

    <header>
        <h1 id="mainTitle">Family Tree</h1>
        <button onclick="resetTree()">Reset Top</button>
    </header>
    
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">-</button>
        <button class="zoom-btn" onclick="fitToScreen()" title="Fit All">â›¶</button>
    </div>

    <div id="viewport">
        <div id="treeLayer" class="tree-layer">
            <div id="loading">Loading Data...</div>
            <div class="tree" id="treeContainer"></div>
        </div>
    </div>

    <script>
        // PASTE YOUR GOOGLE APPS SCRIPT WEB APP URL HERE
        const API_URL = 'https://script.google.com/macros/s/AKfycbxhE4e96J9RkBpFe1wB_ml1vxcARdxPAQC0ef1zEJ1LcDjK9n0vHsurlLN1DXCUsmTq/exec'; 

        let rawData = [];
        
        // --- ZOOM & PAN VARIABLES ---
        let scale = 1;
        let panning = false;
        let pointX = 0;
        let pointY = 0;
        let startX = 0;
        let startY = 0;

        const viewport = document.getElementById('viewport');
        const treeLayer = document.getElementById('treeLayer');

        async function init() {
            try {
                const response = await fetch(API_URL);
                rawData = await response.json();
                document.getElementById('loading').style.display = 'none';
                
                if(rawData.length > 0) {
                   renderTree(rawData[0]["Nama Sendiri"]);
                   // Auto fit after a slight delay to allow rendering
                   setTimeout(fitToScreen, 500); 
                }
            } catch (error) {
                document.getElementById('loading').textContent = "Error: " + error.message;
            }
        }

        // --- RENDER LOGIC (Same as before) ---
        function renderTree(focusName) {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';
            
            const treeHtml = buildHierarchyHTML(focusName);
            const ul = document.createElement('ul');
            ul.innerHTML = treeHtml;
            container.appendChild(ul);

            const count = container.getElementsByClassName('card').length;
            document.getElementById('mainTitle').textContent = `Family tree of "${focusName}"`;
        }

        function buildHierarchyHTML(personName) {
            const person = rawData.find(p => p["Nama Sendiri"] === personName);
            if (!person) return '';
            const children = rawData.filter(p => p["Nama Ayah / Ibu"] === person["Nama Sendiri"]);

            let html = `<li>
                <div class="member-container">
                    ${createCard(person)}
                    ${getSpouseCard(person)}
                </div>`;

            if (children.length > 0) {
                html += '<ul>';
                children.forEach(child => html += buildHierarchyHTML(child["Nama Sendiri"]));
                html += '</ul>';
            }
            html += '</li>';
            return html;
        }

        function getSpouseCard(person) {
            const spouseName = person["Nama Pasangan"];
            if(!spouseName) return '';
            const spouseData = rawData.find(p => p["Nama Sendiri"] === spouseName);
            
            if (spouseData) return createCard(spouseData, true);
            return `<div class="card">
                    <img src="https://via.placeholder.com/80?text=No+Img" alt="Spouse">
                    <h3>${spouseName}</h3>
                    <div class="title">Pasangan</div>
                </div>`;
        }

        function createCard(data, isSpouse = false) {
            const statusClass = (data["Status hidupan"] || '').toLowerCase().includes('meninggal') ? 'status-dead' : 'status-alive';
            const imgUrl = data["URL Gambar"] && data["URL Gambar"].startsWith('http') ? data["URL Gambar"] : 'https://via.placeholder.com/80?text=No+Img';
            const clickAction = isSpouse ? '' : `onclick="reCenterTree('${data["Nama Sendiri"]}')"`;

            return `
                <div class="card" ${clickAction}>
                    <img src="${imgUrl}" alt="Photo">
                    <h3>${data["Nama Sendiri"]}</h3>
                    <div class="title">${data["Gelaran"] || ''}</div>
                    <div class="details">
                        <span class="${statusClass}">${data["Status hidupan"] || ''}</span><br>
                        ${data["No Phone"] || '-'}<br>
                        ${data["Tarikh Lahir"] ? new Date(data["Tarikh Lahir"]).toLocaleDateString() : '-'}
                    </div>
                </div>
            `;
        }

        function resetTree() {
            if(rawData.length > 0) {
                reCenterTree(rawData[0]["Nama Sendiri"]);
            }
        }

        // Wrapper to re-render and fit
        function reCenterTree(name) {
            renderTree(name);
            // Optional: reset view to center, or keep current zoom? 
            // Let's fit to screen to orient the user
            setTimeout(fitToScreen, 100);
        }

        // --- PAN AND ZOOM LOGIC ---

        function setTransform() {
            treeLayer.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
        }

        function zoomIn() {
            scale *= 1.2;
            setTransform();
        }

        function zoomOut() {
            scale /= 1.2;
            setTransform();
        }

        function fitToScreen() {
            // Get dimensions of the tree content
            const treeContent = document.getElementById('treeContainer');
            const contentWidth = treeContent.offsetWidth;
            const contentHeight = treeContent.offsetHeight;
            
            // Get dimensions of the viewport
            const viewWidth = viewport.offsetWidth;
            const viewHeight = viewport.offsetHeight;

            // Calculate Scale to fit (with some padding)
            const scaleX = (viewWidth - 40) / contentWidth;
            const scaleY = (viewHeight - 100) / contentHeight;
            scale = Math.min(scaleX, scaleY, 1); // Do not zoom in more than 100% automatically

            // Center it
            pointX = (viewWidth - contentWidth * scale) / 2;
            pointY = 20; // Start slightly from top

            setTransform();
        }

        // Mouse Drag to Pan
        viewport.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startX = e.clientX - pointX;
            startY = e.clientY - pointY;
            panning = true;
        });

        viewport.addEventListener('mousemove', (e) => {
            if (!panning) return;
            e.preventDefault();
            pointX = e.clientX - startX;
            pointY = e.clientY - startY;
            setTransform();
        });

        viewport.addEventListener('mouseup', () => { panning = false; });
        viewport.addEventListener('mouseleave', () => { panning = false; });

        // Touch Drag for Mobile
        viewport.addEventListener('touchstart', (e) => {
            if(e.touches.length === 1) {
                startX = e.touches[0].clientX - pointX;
                startY = e.touches[0].clientY - pointY;
                panning = true;
            }
        });

        viewport.addEventListener('touchmove', (e) => {
            if(e.touches.length === 1 && panning) {
                // e.preventDefault(); // Uncomment if you want to block standard scroll completely
                pointX = e.touches[0].clientX - startX;
                pointY = e.touches[0].clientY - startY;
                setTransform();
            }
        });

        viewport.addEventListener('touchend', () => { panning = false; });

        // Mouse Wheel Zoom
        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            const xs = (e.clientX - pointX) / scale;
            const ys = (e.clientY - pointY) / scale;
            const delta = -e.deltaY;
            
            (delta > 0) ? (scale *= 1.1) : (scale /= 1.1);
            
            pointX = e.clientX - xs * scale;
            pointY = e.clientY - ys * scale;

            setTransform();
        }, { passive: false });

        init();
    </script>
</body>
</html>

